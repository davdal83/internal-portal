<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Internal Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1rem 2rem;
      background: #f0f2f5;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid #ccc;
    }
    h1 {
      margin: 0;
      color: #004d99;
    }
    button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background-color: #0056b3;
    }
    #stores-list {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .store {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
      flex: 1 1 300px;
      max-width: 300px;
    }
    .photo-wrapper {
      position: relative;
      margin-top: 0.5rem;
      display: inline-block;
      cursor: pointer;
    }
    .photo-wrapper img {
      max-width: 100%;
      border-radius: 6px;
    }
    .delete-photo-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255, 0, 0, 0.8);
      border: none;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-weight: bold;
      line-height: 20px;
      text-align: center;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Internal Portal Dashboard</h1>
    <div>
      Logged in as: <span id="user-email"></span>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <section id="admin-panel" style="display:none; margin: 1em 0; padding: 1em; border: 1px solid #ccc;">
    <h2>Upload New Photo</h2>
    <form id="upload-form">
      <label for="store-select">Select Store:</label>
      <select id="store-select" required></select><br /><br />

      <label for="image-file">Choose Image:</label>
      <input type="file" id="image-file" accept="image/*" required /><br /><br />

      <button type="submit">Upload</button>
      <div id="upload-progress" style="margin-top: 10px;"></div>
    </form>
  </section>

  <section id="stores-section" style="display:none;">
    <h2>Store Locations & Photos</h2>
    <div id="stores-list"></div>
  </section>

  <!-- Lightbox for full image -->
  <div id="lightbox" style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; cursor:pointer; z-index:1000;" onclick="closeLightbox(event)">
    <img id="lightbox-img" style="max-width:90%; max-height:90%; border-radius:8px;" alt="Full Image" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <script>
    // Global admin flag
    let isAdmin = false;

    // Lightbox functions
    function openLightbox(src) {
      const lightbox = document.getElementById("lightbox");
      const img = document.getElementById("lightbox-img");
      img.src = src;
      lightbox.style.display = "flex";
    }
    function closeLightbox(e) {
      e.stopPropagation();
      document.getElementById("lightbox").style.display = "none";
    }

    // Format phone number helper
    function formatPhoneNumber(phoneNum) {
      if (!phoneNum) return "N/A";
      let phoneStr = phoneNum.toString().replace(/\D/g, "");
      if (phoneStr.length !== 10) return phoneStr;
      return `(${phoneStr.slice(0,3)}) ${phoneStr.slice(3,6)}-${phoneStr.slice(6)}`;
    }

    // Check if user is admin
    async function checkIfAdmin(email) {
      const { data, error } = await supabaseClient.from("admins").select("email").eq("email", email).single();
      return data !== null && !error;
    }

    // Load stores and populate list and upload select
    async function loadStores() {
      const { data: stores, error } = await supabaseClient.from("stores").select("*");
      const container = document.getElementById("stores-list");
      const storeSelect = document.getElementById("store-select");

      if (error || !stores) {
        container.innerText = "Error loading stores.";
        return;
      }

      container.innerHTML = "";
      storeSelect.innerHTML = '<option value="" disabled selected>Choose a store</option>';

      for (const store of stores) {
        // Store card
        const storeDiv = document.createElement("div");
        storeDiv.className = "store";
        storeDiv.innerHTML = `
          <h4>${store.store_number} – ${store.store_name}</h4>
          <p>
            <strong>Address:</strong> ${store.store_address}<br />
            <strong>Phone:</strong> ${formatPhoneNumber(store.phone_number)}<br />
            <strong>GM:</strong> ${store.general_manager}
          </p>
          <div id="photos-for-store-${store.id}">Loading photos…</div>
        `;
        container.appendChild(storeDiv);

        // Add option to select
        storeSelect.appendChild(new Option(`${store.store_number} – ${store.store_name}`, store.id));

        // Load photos for this store
        loadPhotos(store.id);
      }
    }

    // Load photos for a given store
    async function loadPhotos(storeId) {
      const { data: photos, error } = await supabaseClient.from("photos").select("*").eq("store_id", storeId);
      const photosDiv = document.getElementById(`photos-for-store-${storeId}`);
      photosDiv.innerHTML = "";

      if (!photos || photos.length === 0) {
        photosDiv.innerText = "No photos uploaded yet.";
        return;
      }

      photos.forEach(photo => {
        const photoWrapper = document.createElement("div");
        photoWrapper.className = "photo-wrapper";

        const img = document.createElement("img");
        img.src = photo.image_url;
        img.alt = `Store ${storeId} Photo`;
        img.onclick = () => openLightbox(photo.image_url);

        photoWrapper.appendChild(img);

        if (isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.className = "delete-photo-btn";
          delBtn.innerText = "×";
          delBtn.title = "Delete photo";
          delBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm("Are you sure you want to delete this photo?")) {
              await deletePhoto(photo.id, photo.image_url);
              loadPhotos(storeId);
            }
          };
          photoWrapper.appendChild(delBtn);
        }

        photosDiv.appendChild(photoWrapper);
      });
    }

    // Delete photo from storage and DB
    async function deletePhoto(photoId, imageUrl) {
      try {
        const url = new URL(imageUrl);
        const pathIndex = url.pathname.indexOf("/store-photos/");
        if (pathIndex === -1) throw new Error("Invalid image URL");

        const filePath = url.pathname.substring(pathIndex + 1);

        const { error: storageError } = await supabaseClient.storage.from("store-photos").remove([filePath]);
        if (storageError) throw storageError;

        const { error: dbError } = await supabaseClient.from("photos").delete().eq("id", photoId);
        if (dbError) throw dbError;

        alert("Photo deleted successfully");
      } catch (error) {
        console.error("Delete error:", error);
        alert(`Failed to delete photo: ${error.message || error}`);
      }
    }

    // Upload image to storage and add to DB
    async function uploadImage(storeId, file) {
      const progress = document.getElementById("upload-progress");
      progress.innerText = "Uploading…";

      const fileExt = file.name.split(".").pop();
      const fileName = `${storeId}/${Date.now()}.${fileExt}`;

      try {
        const { data, error: uploadError } = await supabaseClient.storage.from("store-photos").upload(fileName, file, { upsert: false });
        if (uploadError) throw uploadError;

        const { data: urlData } = supabaseClient.storage.from("store-photos").getPublicUrl(fileName);

        const { error: insertError } = await supabaseClient.from("photos").insert([{ store_id: storeId, image_url: urlData.publicUrl }]);
        if (insertError) throw insertError;

        progress.innerText = "Upload complete.";
        loadPhotos(storeId);
        document.getElementById("upload-form").reset();

      } catch (error) {
        console.error("Upload error:", error);
        progress.innerText = `Upload failed: ${error.message || error}`;
      }
    }

    // Check user session, show dashboard or redirect to login
    async function checkSession() {
      try {
        const { data } = await supabaseClient.auth.getSession();
        const session = data.session;

        if (!session) {
          window.location.href = "login.html";
          return;
        }

        const email = session.user.email;
        document.getElementById("user-email").innerText = email;

        isAdmin = await checkIfAdmin(email);

        if (isAdmin) {
          document.getElementById("admin-panel").style.display = "block";
        }
        document.getElementById("stores-section").style.display = "block";

        loadStores();
      } catch (error) {
        console.error("Session check error:", error);
        window.location.href = "login.html";
      }
    }

    // Logout function
    function logout() {
      supabaseClient.auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    // Upload form submit handler
    document.getElementById("upload-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const storeId = document.getElementById("store-select").value;
      const file = document.getElementById("image-file").files[0];
      if (!storeId || !file) return;
      uploadImage(storeId, file);
    });

    // Run session check on load
    checkSession();
  </script>
</body>
</html>
